/*! gruntDemo 10-03-2017 */
var auditStatusVM=null;avalon.ready(function(){auditStatusVM=avalon.define({$id:"auditStatus",AUDIT_STATUS_NOT_SUBMITTED:0,AUDIT_STATUS_AUDITING:1,AUDIT_STATUS_PASS:2,AUDIT_STATUS_REJECTED:3,QUERY_PARAM_CACHE_KEY:"cacheQueryParam_status",queryAuditStatus:1,uid:"",honorRecords:[],schoolTerms:[],grades:[],classes:[],termCode:"",gradeCode:"",classCode:"",pageNo:1,total:1,records:0,queryParam:{},rejectedMsg:"",isBack:!1,termDone:!1,gradeDone:!1,init:function(){auditStatusVM.uid=getLocalValue("account","uid");var a=getQueryString("backKey");a&&(a=parseInt(a,10),auditStatusVM.queryAuditStatus=isNaN(a)?1:a,auditStatusVM.isBack=!0),auditStatusVM.setQueryParamByUserType(),auditStatusVM.querySchoolTerms()},setQueryParamByUserType:function(){vmHeaderPage.userType===tagNameAndNum.教师?(auditStatusVM.queryGradesAndClasses(),auditStatusVM.queryParam={pageNo:1,termCode:"",gradeCode:"",classCode:"",creator:auditStatusVM.uid,auditStatus:auditStatusVM.queryAuditStatus}):vmHeaderPage.userType===tagNameAndNum.学生&&(auditStatusVM.queryParam={pageNo:1,termCode:"",creator:auditStatusVM.uid,studentId:auditStatusVM.uid,auditStatus:auditStatusVM.queryAuditStatus})},querySchoolTerms:function(){$.ajaxFun({url:"/grow/eval/getSchoolTermList",type:"get",dataType:"json",onSuccess:function(a){avalon.log(a),isSuccess(a)&&(auditStatusVM.schoolTerms=a.bizData,auditStatusVM.schoolTerms.length>0&&(auditStatusVM.isBack?(auditStatusVM.termDone=!0,auditStatusVM.termCode=getLocalValue(auditStatusVM.QUERY_PARAM_CACHE_KEY,"termCode")):auditStatusVM.termCode=auditStatusVM.schoolTerms[0].code))}})},queryGradesAndClasses:function(){$.ajaxFun({url:"/grow/eval/getGradeAndClassBySchool",type:"get",dataType:"json",onSuccess:function(a){avalon.log(a),isSuccess(a)&&(auditStatusVM.grades=a.bizData,auditStatusVM.isBack&&(auditStatusVM.gradeDone=!0,auditStatusVM.gradeCode=getLocalValue(auditStatusVM.QUERY_PARAM_CACHE_KEY,"gradeCode")||""))}})},queryClassesByGrade:function(a){for(var b,c=0,d=auditStatusVM.grades.length;c<d;c++)if(b=auditStatusVM.grades[c],b.code==auditStatusVM.gradeCode){auditStatusVM.classes=b.classes,auditStatusVM.classes.length>0&&(auditStatusVM.isBack?auditStatusVM.classCode=getLocalValue(auditStatusVM.QUERY_PARAM_CACHE_KEY,"classCode")||"":auditStatusVM.classCode=auditStatusVM.classes[0].code);break}},changeQueryStatus:function(a){auditStatusVM.queryAuditStatus=a,auditStatusVM.queryParam.auditStatus=a,auditStatusVM.queryPage(1)},queryPage:function(a){""==auditStatusVM.termCode||a>auditStatusVM.total||a<1||(auditStatusVM.pageNo=a,auditStatusVM.queryParam.pageNo=a,auditStatusVM.honorRecords=[],auditStatusVM.queryHonorRecords())},queryHonorRecords:function(){openLoading(),$.ajaxFun({url:"/grow/honor/record/pagingHonorRecords",type:"post",dataType:"json",data:auditStatusVM.queryParam.$model,onSuccess:function(a){avalon.log(a),isSuccess(a)&&(setLocalValue(auditStatusVM.QUERY_PARAM_CACHE_KEY,auditStatusVM.queryParam),auditStatusVM.pageNo=a.bizData.page,auditStatusVM.records=a.bizData.records,auditStatusVM.total=a.bizData.total,auditStatusVM.honorRecords=a.bizData.rows,0===auditStatusVM.honorRecords.length?$("#noDataTip_honor_auditStatus").show():$("#noDataTip_honor_auditStatus").hide()),closeLoading()}})},seeRejectedMsg:function(a){auditStatusVM.rejectedMsg=a,layer.open({type:1,title:"提示",content:$("#rejected")})},deleteRecord:function(a){layer.confirm("确定要删除该记录？",function(){$.ajaxFun({url:"/grow/honor/record/delete",type:"post",dataType:"json",data:{recordCode:a},onSuccess:function(a){avalon.log(a),isSuccess(a)?a.bizData.success?layer.alert(a.bizData.msg,function(a){layer.close(a),auditStatusVM.queryPage(1)}):layer.alert(a.bizData.msg):layer.alert(a.msg)}}),layerClose()})},editHonorRecord:function(a,b){vmHeaderPage.userType===tagNameAndNum.教师?window.location.href="recordHonorAdmin.html?recordCode="+a+"&backKey="+b:vmHeaderPage.userType===tagNameAndNum.学生&&(window.location.href="recordHonorStu.html?recordCode="+a+"&backKey="+b)},closeLayer:function(){layerClose()},changeBackState:function(){auditStatusVM.isBack&&auditStatusVM.termDone&&auditStatusVM.gradeDone&&(auditStatusVM.isBack=!1)},goBack:function(){auditStatusVM.isBack=!1,setLocalValue(auditStatusVM.QUERY_PARAM_CACHE_KEY,null),vmHeaderPage.userType===tagNameAndNum.教师?window.location.href="listHonorAdmin.html":vmHeaderPage.userType===tagNameAndNum.学生&&(window.location.href="listHonorStu.html")}}),auditStatusVM.$watch("termCode",function(a){if(auditStatusVM.queryParam.termCode=a,auditStatusVM.isBack)return void(vmHeaderPage.userType==tagNameAndNum.学生?auditStatusVM.queryPage(1):auditStatusVM.termDone&&auditStatusVM.gradeDone?(auditStatusVM.isBack=!1,auditStatusVM.queryPage(1)):auditStatusVM.termDone&&!auditStatusVM.gradeDone&&(auditStatusVM.gradeCode=null));auditStatusVM.queryPage(1)}),auditStatusVM.$watch("gradeCode",function(a){if(auditStatusVM.queryParam.gradeCode=a,""==a)return auditStatusVM.classes=[],void(""==auditStatusVM.classCode?auditStatusVM.$fire("classCode",""):auditStatusVM.classCode="");auditStatusVM.queryClassesByGrade()}),auditStatusVM.$watch("classCode",function(a){auditStatusVM.queryParam.classCode=a,auditStatusVM.changeBackState(),auditStatusVM.queryPage(1)}),avalon.scan($("#auditStatus")[0],auditStatusVM),auditStatusVM.init()});